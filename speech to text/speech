from flask import Flask, jsonify, render_template_string
import speech_recognition as sr

app = Flask(__name__)
recognizer = sr.Recognizer()

@app.route('/')
def index():
    return render_template_string('''
        <!DOCTYPE html>
        <html>
        <head>
            <title>Speech-to-Text</title>
        </head>
        <body>
            <h1>Speech-to-Text API</h1>
            <button onclick="startRecording()">Start Recording</button>
            <p id="result"></p>
            <script>
                function startRecording() {
                    fetch('/microphone')
                        .then(response => response.json())
                        .then(data => {
                            if (data.transcript) {
                                document.getElementById('result').innerText = "Transcript: " + data.transcript;
                            } else {
                                document.getElementById('result').innerText = "Error: " + data.error;
                            }
                        });
                }
            </script>
        </body>
        </html>
    ''')

@app.route('/microphone', methods=['GET'])
def transcribe_from_microphone():
    try:
        with sr.Microphone() as source:
            print("Speak now...")
            recognizer.adjust_for_ambient_noise(source)
            audio_data = recognizer.listen(source)
            transcript = recognizer.recognize_google(audio_data)
            return jsonify({"transcript": transcript}), 200

    except sr.UnknownValueError:
        return jsonify({"error": "Could not understand the audio."}), 400

    except sr.RequestError as e:
        return jsonify({"error": f"Could not request results; {e}"}), 500

if __name__ == '__main__': 
    app.run(debug=True)